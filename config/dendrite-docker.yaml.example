# Dendrite Configuration for Docker deployment

version: 2

global:
  server_name: api.yifanyiscrm.com
  private_key: /var/dendrite/keys/matrix_key.pem
  
  # Database configuration
  database:
    connection_string: postgresql://dendrite:dendrite_secure_password@postgres/dendrite?sslmode=disable
    max_open_conns: 90
    max_idle_conns: 5
    conn_max_lifetime: -1
  
  # Jetstream NATS server
  jetstream:
    in_memory: false
    storage_path: /var/dendrite/jetstream
    topic_prefix: Dendrite
    
  # Metrics
  metrics:
    enabled: true
    basic_auth:
      username: metrics
      password: metrics_password
  
  # DNS cache
  dns_cache:
    enabled: true
    cache_size: 256
    cache_lifetime: "10m"
  
  # Server notices
  server_notices:
    enabled: false
  
  # Trusted third-party ID servers
  trusted_third_party_id_servers:
    - matrix.org
    - vector.im
  
  # Presence
  presence:
    enable_inbound: true
    enable_outbound: true

# Application services
app_service_api:
  # Disable registration by default
  disable_tls_validation: false
  config_files:
    - /etc/dendrite/appservices/mautrix-whatsapp.yaml
    - /etc/dendrite/appservices/mautrix-telegram.yaml

# Client API
client_api:
  # Listen address
  internal_api:
    listen: http://0.0.0.0:7771
    connect: http://dendrite:7771
  external_api:
    listen: http://0.0.0.0:8008
  
  # Registration
  registration_disabled: true
  registration_shared_secret: "f6cc9bcee3d474517feb23d636d1e0bf4b89315b53547d26bae2550b3c9364a3"
  enable_registration_captcha: false
  guests_disabled: true
  
  # Rate limiting
  rate_limiting:
    enabled: true
    threshold: 20
    cooloff_ms: 500
  
  # TURN server configuration for VoIP
  turn:
    turn_user_lifetime: "1h"
    turn_uris: []
    turn_shared_secret: ""

# Federation API
federation_api:
  internal_api:
    listen: http://0.0.0.0:7772
    connect: http://dendrite:7772
  external_api:
    listen: http://0.0.0.0:8448
  
  # Federation configuration
  disable_tls_validation: false
  prefer_direct_fetch: false
  disable_http_keepalives: false
  send_max_retries: 16
  
  # Key perspectives for verification
  key_perspectives:
    - server_name: matrix.org
      keys:
        - key_id: ed25519:auto
          public_key: Noi6WqcDj0QmPxCNQqgezwTlBKrfqehY1u2FyWP9uYw

# Media API
media_api:
  internal_api:
    listen: http://0.0.0.0:7774
    connect: http://dendrite:7774
  external_api:
    listen: http://0.0.0.0:8008
  
  # Storage configuration
  base_path: /var/dendrite/media
  max_file_size_bytes: 104857600  # 100MB
  dynamic_thumbnails: true
  max_thumbnail_generators: 10
  thumbnail_sizes:
    - width: 32
      height: 32
      method: crop
    - width: 96
      height: 96
      method: crop
    - width: 320
      height: 240
      method: scale
    - width: 640
      height: 480
      method: scale
    - width: 800
      height: 600
      method: scale

# MSCs (Matrix Spec Changes)
mscs:
  # Threading support
  msc2836:
    enabled: true
  # Refresh token support
  msc2918:
    enabled: true

# Room Server
room_server:
  internal_api:
    listen: http://0.0.0.0:7770
    connect: http://dendrite:7770

# Sync API
sync_api:
  internal_api:
    listen: http://0.0.0.0:7773
    connect: http://dendrite:7773
  external_api:
    listen: http://0.0.0.0:8008
  
  # Search configuration
  search:
    enabled: true
    index_path: /var/dendrite/search
    language: "en"

# User API
user_api:
  internal_api:
    listen: http://0.0.0.0:7781
    connect: http://dendrite:7781
  
  # Account database
  bcrypt_cost: 10
  auto_join_rooms:
    - "#general:api.yifanyiscrm.com"

# Key Server
key_server:
  internal_api:
    listen: http://0.0.0.0:7779
    connect: http://dendrite:7779

# Relay API (for P2P)
relay_api:
  internal_api:
    listen: http://0.0.0.0:7775
    connect: http://dendrite:7775
  external_api:
    listen: http://0.0.0.0:8008

# Logging
logging:
  - type: std
    level: info
  - type: file
    level: info
    params:
      path: /var/dendrite/logs